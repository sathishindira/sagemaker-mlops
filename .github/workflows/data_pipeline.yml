name: Data pipeline (ingest -> preprocess -> dvc push)

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
  # schedule:
  #   - cron: '0 * * * *'   # hourly ingest (example)
permissions:
  contents: read
  id-token: write
  
jobs:
  ingest_preprocess:
    runs-on: ubuntu-latest
    env:
      DVC_REMOTE: ${{ secrets.S3_DVC_REMOTE }}
    steps:
    
    - uses: actions/checkout@v6.0.1
    
    - name: Setup python
      uses: actions/setup-python@v6.1.0
      with: 
        python-version: '3.13'
        
    #Connect AWS account with OIDC Provider
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v5.1.1
      with:
        aws-region: us-east-1
        role-to-assume: arn:aws:iam::805702559038:role/Github_Actions_EKS_Repo

    - name: Cache pip
      uses: actions/cache@v5.0.0
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

    - name: Install deps
      run: pip install -r requirements.txt
        
    - name: dvc pull (ensure latest artifacts)
      run: |
        dvc remote add -f origin $DVC_REMOTE || true
        dvc pull
             
    # - name: Run preprocessing
    #   run: python src/preprocess.py --input data/raw/ --output data/processed/
      
    # - name: dvc add processed data
    #   run: |
    #     dvc add data/processed
    #     git add data/processed.dvc .gitignore
    #     git commit -m "Data: updated processed snapshot [ci]" || echo "no changes"
        
    # - name: dvc push
    #   run: dvc push
      
    # - name: Create dataset tag (optional)
    #   run: |
    #     DATA_TAG=$(date -u +%Y%m%dT%H%M%SZ)
    #     git tag -a "data-${DATA_TAG}" -m "data snapshot ${DATA_TAG}" || true
    #     git push --tags || true
